<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<script>
    window.Module = {};
    let buffer = null;
    let bufferSize = 0;
    let audio = new Uint8Array(0);
    let caches = [];
    window.caches = caches;
    window.__CODEC_BRIDGE__ = {
        onHeader(header) {
            // ...........
        },
        onMediaInfo(json) {
            // ...........
        },
        onAudioDataSize({size}) {
            bufferSize = size;
            buffer = Module._malloc(size);
            Module._codecSetAudioBuffer(buffer);
        },
        onAudioData({timestamp}) {
            const data = new Uint8Array(Module.HEAPU8.subarray(buffer, buffer + bufferSize));
            caches.push(data);
            Module._free(buffer);
        },
        onComplete() {
            caches = caches.slice(532, 965);
            audio = caches.reduce((i, j) => {
                const buffer = new Uint8Array(i.length + j.length);
                buffer.set(i, 0);
                buffer.set(j, i.length);
                return buffer;
            }, audio);

            // stream audio data parse
            const context = new AudioContext();
            const source = context.createBufferSource();
            context.decodeAudioData(audio.buffer).then((buffer) => {
                source.buffer = buffer;
                source.connect(context.destination);
                source.loop = false;
                source.start(0);
            });

            Module._codecFree();
        }
    };

    const MAX_STEP = 1024 * 1024;
    window.Module['onRuntimeInitialized'] = () => {
        fetch('./mtv.flv').then(resp => resp.arrayBuffer()).then(buffer => {
            Module._codecInit();
            const callbackStr = '__CODEC_BRIDGE__';
            const splitData = callbackStr.split('').map(v => v.charCodeAt(0)).concat(0);
            const callbackStrData = Module._malloc(callbackStr.length + 1);
            Module.HEAPU8.set(splitData, callbackStrData);
            Module._codecSetBridgeName(callbackStrData);

            let timestamp = +new Date();
            buffer = new Uint8Array(buffer);
            while (buffer.length > 0) {
                console.log(0, MAX_STEP > buffer.length ? buffer.length : MAX_STEP);
                const subarray = buffer.subarray(0, MAX_STEP > buffer.length ? buffer.length : MAX_STEP);
                const data = Module._malloc(subarray.byteLength);
                Module.HEAPU8.set(subarray, data);
                Module._codecDecode(data, subarray.byteLength);
                Module._free(data);
                if (buffer.length < MAX_STEP) {
                    break;
                }
                buffer = buffer.subarray(MAX_STEP, buffer.length);

                const now = +new Date();
                console.log('>>>>>>>>>>>>>>>>' + (now - timestamp));
                timestamp = now;
            }
        });
    }
</script>
<script src="prod.js"></script>
</body>
</html>