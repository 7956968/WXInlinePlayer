<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.5" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
      }
      #wrapper {
        width: 800px;
        height: 500px;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-left: -400px;
        margin-top: -250px;
      }
    </style>
  </head>
  <body>
    <div id="wrapper">
      <div style="margin-bottom: 10px">
        <button id="normal">普通Video</button>
        <button id="picture">纯视频（动画）</button>
        <button id="music">纯音频</button>
      </div>
      <canvas
        id="canvas"
        width="800"
        height="450"
        style="background: black;"
      ></canvas>
      <div style="margin-bottom: 10px">
        <span id="status">状态：等待播放</span>
        <span id="duration" style="display: inline-block; margin-left: 50px;"
          >可播放时长: 0s</span
        >
        <span id="time" style="display:inline-block; margin-left: 50px;"
          >进度：0s</span
        >
      </div>
      <button id="playBtn">播放</button>
      <button id="stopBtn">停止</button>
      <button id="pauseBtn">暂停</button>
      <button id="resumeBtn">恢复</button>
      <button id="muteBtn">静音切换</button>

      <input
        type="number"
        name="volume"
        step="0.1"
        max="1.0"
        min="0.0"
        value="1.0"
        style="width: 100px;"
      />
      <span>音量设置</span>
    </div>
    <script src="https://static.petera.cn/index.js"></script>
    <script>
      const VIDEO_URL = 'https://static.petera.cn/mm.flv';
      const PIC_URL = 'https://static.petera.cn/mm1.flv';
      const MUSIC_URL = 'https://static.petera.cn/mm2.flv';

      let type = 0;
      let chunkSize = 128 * 1024;
      let url = VIDEO_URL;

      const href = location.href;
      const qsIndex = href.lastIndexOf('?');
      if (qsIndex > -1) {
        type = href.slice(qsIndex + 1).split('=')[1];
        if (type == 1) {
          url = PIC_URL;
        } else if (type == 2) {
          url = MUSIC_URL;
          chunkSize = 32 * 1024;
        }
      }

      document.getElementById('normal').addEventListener('click', () => {
        location.href = location.origin + location.pathname + '?t=0';
      });

      document.getElementById('picture').addEventListener('click', () => {
        location.href = location.origin + location.pathname + '?t=1';
      });

      document.getElementById('music').addEventListener('click', () => {
        location.href = location.origin + location.pathname + '?t=2';
      });

      console.log('>>>>>>>> load: ' + url);

      const $status = document.getElementById('status');
      const $time = document.getElementById('time');
      const $duration = document.getElementById('duration');

      if (WXInlinePlayer.isSupport()) {
        WXInlinePlayer.init({
          // asmUrl: './prod.baseline.asm.combine.js?v=201908311154',
          // wasmUrl: './prod.baseline.wasm.combine.js?v=201908311154'
          asmUrl: 'https://static.petera.cn/prod.all.asm.combine.js',
          wasmUrl: 'https://static.petera.cn/prod.all.wasm.combine.js'
        });

        const $canvas = document.getElementById('canvas');
        WXInlinePlayer.ready().then(() => {
          type = parseInt(type) || 0;
          const player = new WXInlinePlayer({
            url: url,
            $container: $canvas,
            hasVideo: true,
            hasAudio: !type || type == 2,
            volume: 1.0,
            muted: false,
            autoplay: true,
            loop: true,
            isLive: false,
            chunkSize: chunkSize,
            preloadTime: 5e2,
            bufferingTime: 1e3,
            cacheSegmentCount: 64,
            customLoader: null
          });

          document.getElementById('playBtn').addEventListener('click', () => {
            player.play();
          });

          document.getElementById('stopBtn').addEventListener('click', () => {
            player.stop();
          });

          document.getElementById('pauseBtn').addEventListener('click', () => {
            player.pause();
          });

          document.getElementById('resumeBtn').addEventListener('click', () => {
            player.resume();
          });

          document.getElementById('muteBtn').addEventListener('click', () => {
            player.mute(!player.mute());
          });

          document
            .querySelector('input[name=volume]')
            .addEventListener('change', ev => {
              player.volume(ev.target.value);
            });

          player.on('mediaInfo', mediaInfo => {
            const { onMetaData } = mediaInfo;
            $canvas.height = onMetaData.height;
            $canvas.width = onMetaData.width;
            for (let i = 0; i < onMetaData.length; i++) {
              if ('height' in onMetaData[i]) {
                $canvas.height = onMetaData[i].height;
              } else if ('width' in onMetaData[i]) {
                $canvas.width = onMetaData[i].width;
              }
            }
          });

          player.on('buffering', () => {
            $status.innerHTML = '状态: 等待加载';
          });

          player.on('playing', () => {
            $status.innerHTML = '状态: 正在播放';
          });

          player.on('stopped', () => {
            $status.innerHTML = '状态：已停止';
          });

          player.on('end', () => {
            $status.innerHTML = '状态：播放结束';
          });

          player.on('timeUpdate', timestamp => {
            $time.innerHTML = '进度：' + Math.floor(timestamp / 1000) + 's';
            $duration.innerHTML =
              '可播放时长: ' +
              Math.ceil(player.getAvaiableDuration() / 1000) +
              's';
          });
        });
      }
    </script>
  </body>
</html>
